---
title: "Example_Run"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example_Run}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    eval = FALSE
)
```

```{r setup, eval=TRUE}
library(brainstorm)
library(VariantAnnotation)
library(here)
library(dplyr)
library(ggplot2)
library(purrr)
```

#Prep Data
## Prep DNA data
```{r "prep snpsGeno"}
snpsGeno_VCF
snpsGeno <- make_snpsGeno(snpsGeno_VCF)
snpsGeno[1:5, 1:5]
```

## Prep RNA data
### Filter "snps called" data
```{r}
called <- readVcf(here("data", "mergedVariants.vcf.gz"), "hg38")
dim(called)
called_filter <- filter_called(called)
dim(called_filter)
```

### Create snpsGeno2 and snpsCalled
```{r}
snpsRNA <- make_snpsRNA(genotyped, called_filter)
print("Matching Genotype snps")
snpsRNA$snpsGeno2[1:5, 1:5]
print("Called RNA snsp")
snpsRNA$snpsCalled[1:5, 1:5]
```

# Build Correlation Tables
## DNA vs. DNA
```{r}
# brain_sentrix <-
#     read.csv(system.file(
#         "extdata",
#         "brain_sentrix.csv",
#         package = "brainstorm",
#         mustWork = TRUE
#     ))

brain_sentrix <- read.csv(here("Data","brain_sentrix_speaqeasy.csv"))
all(colnames(snpsGeno) %in% brain_sentrix$ID)

corLong_dna_dna <- make_corLong(snpsGeno, BrainTable1 = brain_sentrix)
head(corLong_dna_dna)
```
```{r}
corLong_dna_dna %>%
    filter(row_BrNum == col_BrNum) %>%
    ggplot(aes(x = cor)) +
    geom_density() +
    geom_vline(xintercept = 0.59, color = "red", linetype = "dashed")
```



## RNA vs. RNA
```{r}
# pd_swap <- read.csv(here("data", "pd_swap.csv"))
corLong_rna_rna <- make_corLong(
    snps1 = snpsRNA$snpsCalled,
    BrainTable1 = pd_example,
    ID_col1 = "SAMPLE_ID"
)
head(corLong_rna_rna)
```

```{r}
corLong_rna_rna %>%
    filter(row_BrNum == col_BrNum) %>%
    ggplot(aes(x = cor)) +
    geom_density() +
    geom_vline(xintercept = 0.59, color = "red", linetype = "dashed")
```

## DNA vs. RNA
```{r}
corLong_dna_rna <- make_corLong(
    snps1 = snpsRNA$snpsGeno2,
    snps2 = snpsRNA$snpsCalled,
    BrainTable1 = brain_sentrix,
    BrainTable2 = pd_example,
    ID_col1 = "ID",
    ID_col2 = "SAMPLE_ID"
)

head(corLong_dna_rna)
```

```{r}
corLong_dna_rna %>%
    filter(row_BrNum == col_BrNum) %>%
    ggplot(aes(x = cor)) +
    geom_density() +
    geom_vline(xintercept = 0.59, color = "red", linetype = "dashed")
```

# Run Grouper
```{r}
corLong_dna_dna2 <- corLong_dna_dna %>% filter(cor > 0.6)
dna_dna_groups <- grouper(corLong_dna_dna2)
length(dna_dna_groups)
table(unlist(purrr::map(dna_dna_groups, "nBrNum")))
```

```{r}
map(c(corLong_dna_dna, corLong_rna_rna), colnames)
corLong_all <- do.call("rbind", c(corLong_dna_dna, corLong_rna_rna))
```



## Find problem groups & samples
```{r}
dna_dna_prob <- keep(dna_dna_groups, ~ .x$nBrNum > 1)
length(dna_dna_prob)
```


# Session Info
```{r}
sessioninfo::session_info()
```

